/*
 (c) 2009 (jrj.com)
 @author jianjun.wang@jrj.com.cn 
 @date 2010.1.5
 @depend jquery-1.2.6
 @version 0.5
*/
if("undefined"==typeof JRJ||!JRJ)var JRJ={};"undefined"!=typeof JRJ.ui&&JRJ.ui||(JRJ.ui={});var regEntities=/[<>"\u00ae\u00a9]/g,arrEntities={"<":"&lt;",">":"&gt;",'"':"&quot;","\u00ae":"&reg;","\u00a9":"&copy;"},arrFontsize=[{n:"x-small",s:"10px",t:"\u6781\u5c0f"},{n:"small",s:"13px",t:"\u7279\u5c0f"},{n:"medium",s:"16px",t:"\u5c0f"},{n:"large",s:"18px",t:"\u4e2d"},{n:"x-large",s:"24px",t:"\u5927"},{n:"xx-large",s:"32px",t:"\u7279\u5927"},{n:"-webkit-xxx-large",s:"48px",t:"\u6781\u5927"}];
(function(c){JRJ.ui.MiniEditor=function(a){var b={name:"",width:300,height:200,value:"",containerId:"",hasFocus:!1,hasToolBar:!0,title:"",num:400,submitType:"text",onSubmit:function(){}};c.extend(b,a);this.editorName=b.name;this.width=b.width;this.height=b.height;this.value=b.value;this.hasFocus=b.hasFocus;this.hasToolBar=b.hasToolBar;this.containerId=b.containerId;this.submitType=b.submitType;this.onSubmit=b.onSubmit;this.title=b.title;this.num=b.num;this.UnenableDefaultImgEdit=b.UnenableDefaultImgEdit||
!0;this.editorDocument=this.editorWindow=this.editorIframe=this.editorObj=null;this.isfocus=!1;this.isIE6=(this.isIE=c.browser.msie)&&6>=parseInt(c.browser.version);this.EMOTE_TITLE="\u5fae\u7b11 \u8c04\u5a9a \u5077\u7b11 \u5927\u7b11 \u5bb3\u7f9e \u8c03\u76ae \u5f97\u610f \u800d\u9177 \u8bbd\u523a \u59d4\u5c48 \u90c1\u95f7 \u96be\u8fc7 \u6d41\u6cea \u5927\u54ed \u53d1\u706b \u5492\u9a82 \u53d1\u5446 \u4e0d\u60d1 \u7591\u60d1 \u5403\u60ca \u6d41\u6c57 \u5c34\u5c2c \u60ca\u6050 \u95ed\u5634 \u72af\u56f0 \u7761\u89c9 \u998b \u5410 \u8033\u8bed \u6d77\u76d7 \u91cd\u4f24 \u62e5\u62b1 \u723d \u5f3a \u9177 \u8d5e \u7ea2\u5fc3 \u5fc3\u788e \u82b1\u5f00 \u82b1\u8c22 \u90ae\u4ef6 \u624b\u52bf-\u68d2 \u624b\u52bf-\u900a \u63e1\u624b \u7535\u8bdd \u624b\u673a \u5634\u5507 v \u592a\u9633 \u6708\u4eae \u661f\u661f \u706f\u6ce1 \u7535\u89c6 \u95f9\u949f \u793c\u7269 \u73b0\u91d1 \u5496\u5561 \u996d \u897f\u74dc \u756a\u8304 \u836f\u4e38 \u732a\u5934 \u8db3\u7403 \u4fbf\u4fbf".split(" ");
this.create()};JRJ.ui.MiniEditor.prototype={create:function(){var a='<div id="jrje_'+this.editorName+'" style="position:absolute;width:'+this.width+"px;height:"+this.height+'px"></div>';""==this.containerId?document.write(a):c("#"+this.containerId).html(a);this.editorObj=c("#jrje_"+this.editorName);var a=c('<div class="jrje-toolbar"></div>'),b;b='<div class="jrje-sbtn">'+('<img id="jrje_sbtn_'+this.editorName+'" src="http://i0.jrjimg.cn/wap2014/images/imgg.png"/>');b+='<span class="jrje-sbtn-span">Ctrl+Enter\u53d1\u5e03\u4e92\u52a8</span><button class="jrje-sbtn-submit">\u63d0\u4ea4</button>';
b+="</div>";c(b).appendTo(a);b=c("<div></div>");var d=this.height;this.hasToolBar?d=this.height-38:(d=this.height,a.css("display","none"));b.css({width:this.width-2+"px",height:d+"px",border:"1px solid #CCC",overflow:"auto","-webkit-overflow-scrolling":"touch"});d=c('<iframe id="jrjIf_'+this.containerId+'"></iframe>');d.attr("width","100%");d.attr("height","100%");d.attr("frameBorder","0");d.attr("allowtransparency","true");d.appendTo(b);c('<div class="jrje-topbar"><div class="jrje-topbar-title">'+
this.title+'</div><div class="jrje-topbar-num">\u60a8\u8fd8\u53ef\u4ee5\u8f93\u5165 <span class="jrje-topbar-num-span">'+this.num+'</span> \u5b57</div></div><div id="atSomeOne" class="jrje_rply" style="display: none;">\u56de\u590d <span class="f_bl"></span> \u7684\u53d1\u8a00</div>').appendTo(this.editorObj);b.appendTo(this.editorObj);a.appendTo(this.editorObj);this.editorIframe=d[0];this.smileyBtn=c("#jrje_sbtn_"+this.editorName);this.init()},init:function(){this.editorWindow=this.editorIframe.contentWindow;
this.editorDocument=this.editorWindow.document;this.editorDocument.designMode="On";this.editorDocument.open();var a=c.browser.msie?"0px":"3px",b;b='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>';b+='<meta http-equiv="content-type" content="text/html; charset=utf-8" />';b+="<style>body{word-wrap:break-word;word-break:break-all;background:transparent;padding:"+a+";margin:0;font-family:\u5b8b\u4f53;font-size:14px;} p{padding:0;margin:0;}</style>";
b+="</head>";b+='<body spellcheck="false">';b=c.browser.msie?b+("<p>"+this.value+"</p>"):""==this.value?b+'<br type="_moz"/>':b+("<p>"+this.value+"</p>");b+="</body></html>";this.editorDocument.write(b);this.editorDocument.close();this.UnenableDefaultImgEdit&&c(this.editorDocument).bind("mousemove",{obj:this},function(a){a.data.obj.setImgCantEdit(a)});c(this.editorDocument).bind("keypress",{obj:this},function(a){var b=a.data.obj;b.keypress();(a.ctrlKey&&13==a.which||10==a.which)&&b._onSubmit()});
c(this.editorDocument.getElementsByTagName("body")[0]).bind("paste",{obj:this},function(a){var b=a.data.obj;setTimeout(function(){b.setHtml(b.formatXHTML(b.getText()))},50)});c("#"+this.containerId).find("button.jrje-sbtn-submit").eq(0).bind("click",{obj:this},function(a){a.data.obj._onSubmit()});c(this.editorDocument).bind("keyup change",{obj:this},function(a){a=a.data.obj;c("#"+a.containerId).find("div.jrje-topbar-num").html(0>a.num-a.getContentLength()?'\u60a8\u5df2\u8d85\u8fc7 <span class="jrje-topbar-num-span">'+
Math.abs(a.num-a.getContentLength())+"</span> \u5b57":'\u60a8\u8fd8\u53ef\u4ee5\u8f93\u5165 <span class="jrje-topbar-num-span">'+Math.abs(a.num-a.getContentLength())+"</span> \u5b57")}).bind("click",function(){});this.smileyBtn.bind("click",{obj:this},function(a){a.stopPropagation();a=a.data.obj;a.isIE&&(a.isIE6||a.editorWindow.focus(),a.currentRange=a.getRange(a.getSelection()));a.showSmiley()});this.hasFocus&&this.editorWindow.focus();var d=this;(function(a,b,c,d){a.addEventListener(b,function(a){c(a,
d)},!1)})(this.editorDocument,"touchend",function(a,b){setTimeout(function(){d.editorWindow.focus()},100)},edit);c(this.editorWindow).focus(function(){d.isfocus=!0})},setImgCantEdit:function(a){a&&(a=a.target,"img"==a.tagName.toLowerCase()?c('<div class="jrj_editor_imgmask"></div>').css({position:"absolute",width:c(a).width()+2,height:c(a).height()+2,left:c(a).offset().left,top:c(a).offset().top+c(this.editorObj).find("div.jrje-topbar").height(),"background-color":"white",opacity:0.1}).appendTo(c(this.editorIframe).parent("div")||
this.editorDocument.body):c(this.editorIframe).parent("div").find("div.jrj_editor_imgmask").remove())},_onSubmit:function(){var a=c("#"+this.containerId).find("button.jrje-sbtn-submit").eq(0);if(!a.hasClass("jrje-sbtn-disable")&&""!=this.getText()){var b=10;a.addClass("jrje-sbtn-disable");var d=setInterval(function(){0>=b?(a.removeClass("jrje-sbtn-disable"),a.text("\u63d0\u4ea4"),window.clearInterval(d)):(a.text(b),b--)},1E3);this.onSubmit("html"==this.submitType?this.getHtml():this.getText())}else if(""==
this.getText())this.onSubmit("html"==this.submitType?this.getHtml():this.getText())},keypress:function(){this.editorDocument.getElementsByTagName("p")[0]||this.editorDocument.execCommand("formatblock",!1,"<p>")},domEncode:function(a){return a.replace(regEntities,function(a){return arrEntities[a]})},formatXHTML:function(a,b){function c(a){var b={};a=a.split(",");for(var d=0;d<a.length;d++)b[a[d]]=!0;return b}function l(a){a=a.toLowerCase();var b=E[a];return b?b:a}function C(a,b,c){if(y[a])for(;f.last()&&
F[f.last()];)q(f.last());G[a]&&f.last()===a&&q(a);(c=z[a]||!!c)||f.push(a);var d=[];d.push("<"+a);b.replace(H,function(a,b,c,w,x){b=b.toLowerCase();d.push(" "+b+'="'+(c?c:w?w:x?x:I[b]?b:"").replace(/"/g,"'")+'"')});d.push((c?" /":"")+">");t(d.join(""),a,!0);"pre"===a&&(r=!0)}function q(a){if(a)for(b=f.length-1;0<=b&&f[b]!==a;b--);else var b=0;if(0<=b){for(var c=f.length-1;c>=b;c--)t("</"+f[c]+">",f[c]);f.length=b}"pre"===a&&(r=!1,m--)}function v(a){t(J.domEncode(a))}function D(a){g.push(a.replace(/^[\s\r\n]+|[\s\r\n]+$/g,
""))}function t(a,c,d){r||(a=a.replace(/(\t*\r?\n\t*)+/g,""));if(r||!0!==b)g.push(a);else if(a.match(/^\s*$/))g.push(a);else{var e=y[c];e?(d&&m++,""===s&&m--):s&&m++;((e?c:"")!==s||e)&&A();g.push(a);"br"===c&&A();!e||!z[c]&&d||m--;s=e?c:""}}function A(){g.push("\r\n");if(0<m)for(var a=m;a--;)g.push("\t")}function u(a,b,c,d){if(!c)return d;a="";(b=c.match(/ face\s*=\s*"\s*([^"]+)\s*"/i))&&(a+="font-family:"+b[1]+";");(b=c.match(/ size\s*=\s*"\s*(\d+)\s*"/i))&&(a+="font-size:"+arrFontsize[(7<b[1]?7:
1>b[1]?1:b[1])-1].s+";");(b=c.match(/ color\s*=\s*"\s*([^"]+)\s*"/i))&&(a+="color:"+b[1]+";");(c=c.match(/ style\s*=\s*"\s*([^"]+)\s*"/i))&&(a+=c[1]);a&&(d='<span style="'+a+'">'+d+"</span>");return d}var J=this,z=c("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed"),y=c("address,applet,blockquote,button,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,table,tbody,td,tfoot,th,thead,tr,ul,script"),
F=c("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var"),G=c("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr"),I=c("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected"),K=c("script,style"),E={b:"strong",i:"em",s:"del",strike:"del"},B=/<(?:\/([^\s>]+)|!([^>]*?)|([\w\-:]+)((?:"[^"]*"|'[^']*'|[^"'<>])*)\s*(\/?))>/g,
H=/\s*([\w\-:]+)(?:\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s]+)))?/g,g=[],f=[];f.last=function(){return this[this.length-1]};for(var h,e,k=0,n,p,m=-1,s="body",r=!1;h=B.exec(a);){e=h.index;e>k&&(k=a.substring(k,e),n?p.push(k):v(k));k=B.lastIndex;if(e=h[1])if(e=l(e),n&&e===n&&(D(p.join("")),p=n=null),!n){q(e);continue}n?p.push(h[0]):(e=h[3])?(e=l(e),C(e,h[4],h[5]),K[e]&&(n=e,p=[])):h[2]&&g.push(h[0])}a.length>k&&v(a.substring(k,a.length));q();a=g.join("");g=null;a=a.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,
u);a=a.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,u);a=a.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,u);return a=a.replace(/^(\s*\r?\n)+|(\s*\r?\n)+$/g,"")},filterWord:function(a){a=a.replace(/<(\w[^>]*) onmouseover="([^\"]*)"([^>]*)/gi,"<$1$3");a=a.replace(/<(\w[^>]*) onmouseout="([^\"]*)"([^>]*)/gi,"<$1$3");a=a.replace(/<H(\d)([^>]*)>/gi,"<h$1>");a=a.replace(/<(H\d)><FONT[^>]*>([\s\S]*?)<\/FONT><\/\1>/gi,
"<$1>$2</$1>");a=a.replace(/<(H\d)><EM>([\s\S]*?)<\/EM><\/\1>/gi,"<$1>$2</$1>");a=a.replace(/<meta[^>]*>/ig,"");a=a.replace(/<link rel="\S+" href="file:[^>]*">/ig,"");a=a.replace(/\x3c!--\[if gte mso [0-9]{1,2}\]>[\s\S]*?<!\[endif\]--\x3e/ig,"");a=a.replace(/<style>[\s\S]*?mso[\s\S]*?<\/style>/ig,"");a=a.replace(/ lang=".+?"/ig,"");a=a.replace(/<o:p><\/o:p>/ig,"");a=a.replace(/ class=msonormal/ig,"");return a=a.replace(/ class="[m|M]so.+?"/ig,"")},showSmiley:function(){c("body").focus();if(this.smileyDialg)return this.closeSmileyDialog(),
!1;this.createSmileyDialog();var a=this.smileyBtn.offset();this.smileyDialg.css({top:a.top-247+"px",left:a.left+2+"px",display:""});this.winResizeHandler=function(a){a=a.data.obj;var c=a.smileyBtn.offset();a.smileyDialg.css({top:c.top-247+"px",left:c.left+2+"px"})};c(window).bind("resize",{obj:this},this.winResizeHandler)},createSmileyDialog:function(){var a;a='<div class="jrje-s-dlg">'+('<div id="jrje_s_con_'+this.editorName+'" class="jrje-s-con">');a+=this.createSimleysHtml(0,64);a+="</div>";var b=
this;this.smileyDialg=c('<div class="jrje-s-dlg1"></div>');this.smileyDialg.html(a);this.smileyDialg.mouseout(function(a){0==c(a.relatedTarget).parents("div.jrje-s-dlg1").length&&b.closeSmileyDialog()});this.smileyDialg.appendTo("body");this.initSimleyEvent();this.smileyPage=1},createSimleysHtml:function(a,b){for(var c="",l=a;l<b;)c+='<div class="jrje-emot"><img class="jrje-smiley s-base-'+(l+1)+'" src="'+("http://i0.jrjimg.cn/live/emote/"+l+".gif")+'" /></div>',l++;return c+'<div style="clear:both"></div>'},
initSimleyEvent:function(){c(".jrje-smiley").hover(function(){c(this).parent().css({cursor:"pointer",border:"1px solid #FADFC3"})},function(){c(this).parent().css({cursor:"default",border:"1px solid #FFF"})});c(".jrje-smiley").bind("click",{obj:this},function(a){a=a.data.obj;var b='<img class="jrje-img" src="'+this.getAttribute("src")+'"/>';a.isIE&&a.selectRange(a.currentRange);a.insertHtml(b);a.closeSmileyDialog()});c(document).bind("click",{obj:this},function(a){a.data.obj.closeSmileyDialog()})},
prePage:function(){if(1==this.smileyPage)return!1;c("#jrje_s_con_"+this.editorName).html(this.createSimleysHtml(0,32));this.initSimleyEvent();this.smileyPage=1;c("#jrje_s_pre_"+this.editorName)[0].className="a1";c("#jrje_s_next_"+this.editorName)[0].className="a2"},nextPage:function(){if(2==this.smileyPage)return!1;c("#jrje_s_con_"+this.editorName).html(this.createSimleysHtml(32,64));this.initSimleyEvent();this.smileyPage=2;c("#jrje_s_pre_"+this.editorName)[0].className="a3";c("#jrje_s_next_"+this.editorName)[0].className=
"a4"},closeSmileyDialog:function(){this.smileyDialg.remove();this.smileyDialg=null;c(window).unbind("resize",this.winResizeHandler)},getHtml:function(){var a=this.editorDocument.body.innerHTML.toLowerCase(),a=a.replace(/&nbsp;/g," "),a=c.trim(a),a=a.replace(/>&nbsp;</g,"><").replace(/\s*</g,"<").replace(/>\s*/g,">"),a=a.replace(/\s+/g," "),a=this.filterWord(a);if("<p></p>"==a||"<p>&nbsp;</p>"==a||"<p><br /></p>"==a||"<br />"==a||"<br>"==a)return"";a=a.replace(/<script[^>]*>[\s\S]*?<\/script[^>]*>/gim,
"");a=a.replace(/<\s*style[\s\S]*?\/style\s*>/gi,"");a=a.replace(/<\s*link[\s\S]*?\/link\s*>/gi,"");a=a.replace(/(<(meta|iframe|frame|html|head|body|title|input|button|select|option|form)[^>]*>|<\/(iframe|frame|meta|html|head|body|title|input|button|select|option|form)>)/gi,"");a=a.replace(/<[a-z][^>]*\s*on[a-z]+\s*=[^>]+/ig,function(a,c){return a.replace(/\s*on[a-z]+\s*=\s*("[^"]+"|'[^']+'|[^\s]+)\s*/ig,"")});a=a.replace(/<\!--.*?--\x3e/gi,"");a=a.replace(/<\!--/gi,"");a=a.replace(/--\x3e/gi,"");
a=a.replace(/<br>/gi,"");a=a.replace(/&lt;\!--.*?--&gt;/gi,"");a=a.replace(/&lt;\!--/gi,"");a=a.replace(/--&gt;/gi,"");a=a.replace(/<br.*?>/gi,"<br />");a=a.replace(/(<hr\s+[^>]*[^\/])(>)/gi,"$1 />");return a=a.replace(/(<img\s+[^>]*[^\/])(>)/gi,"$1 />")},getText:function(){var a=this.getHtml();return a=a.replace(/<\/?\s*(?!br|img class="?jrje-img"?)+\b[^>]*>/gi,"")},setHtml:function(a){this.editorDocument.body.innerHTML=a},insertHtml:function(a){this.editorWindow.focus();if(this.isIE){var b=this.getSelection();
if("undefined"==this.getRange(b).text)return this.getRange(b).text="",!1;b.createRange().pasteHTML(a)}else this.editorDocument.execCommand("inserthtml",!1,a);this.editorWindow.focus()},getSelection:function(){var a=null;return a=this.editorDocument.selection?this.editorDocument.selection:this.editorWindow.getSelection()},getRange:function(a){var b=null;return b=a.createRange?a.createRange():a.getRangeAt(0)},selectRange:function(a){a.select?a.select():this.editorWindow.getSelection()},getContentLength:function(){var a=
this.editorDocument;if(this.isIE)a=a.body.innerText.length;else{var b=a.createRange();b.selectNodeContents(a.body);a=b.toString().length}return a}};window.JRJMiniEditor=JRJ.ui.MiniEditor})(jQuery);
